nextflow_pipeline {

    name "Test Dorado basecalling integration"
    script "../main.nf"

    test("Should handle Dorado configuration without POD5 files") {

        when {
            params {
input = "$projectDir/tests/test_samplesheet.csv"
                outdir = "$outputDir"
                
                // Enable Dorado but no POD5 input
                use_dorado = true
                dorado_path = "/Users/andreassjodin/Downloads/dorado-1.1.1-osx-arm64/bin/dorado"
                pod5_input_dir = null  // No POD5 files, should skip Dorado
                
                // Disable other features
                realtime_mode = false
                kraken2_db = null
                blast_validation = false
                
                // Resource limits
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '1.h'
            }
        }

        then {
            assert workflow.success
            
            // Should not run Dorado processes without POD5 input
            assert !workflow.trace.tasks().any { it.name.contains('DORADO') }
            
            // Should still run standard QC workflow
            assert workflow.trace.tasks().any { it.name.contains('FASTP') }
        }
    }

    test("Should validate Dorado parameters") {

        when {
            params {
input = "$projectDir/tests/test_samplesheet.csv"
                outdir = "$outputDir"
                
                // Test parameter validation
                use_dorado = false  // Disabled
                dorado_model = "dna_r10.4.1_e4.3_400bps_hac@v5.0.0"
                min_qscore = 9
                demultiplex = false
                barcode_kit = "SQK-PBK004"
                trim_barcodes = true
                
                // Resource limits
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '1.h'
            }
        }

        then {
            assert workflow.success
            
            // Parameters should be accessible but Dorado shouldn't run
            assert !workflow.trace.tasks().any { it.name.contains('DORADO') }
        }
    }
}