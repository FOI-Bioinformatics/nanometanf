nextflow_pipeline {

    name "Test real-time statistics modules"
    script "../main.nf"

    test("Should generate comprehensive snapshot statistics") {

        when {
            params {
                input = "$projectDir/assets/test_data/test_samplesheet_absolute.csv"
                outdir = "$outputDir"
                
                // Enable real-time statistics
                enable_realtime_stats = true
                realtime_mode = false
                
                // Disable heavy processing
                use_dorado = false
                kraken2_db = null
                blast_validation = false
                skip_fastp = true
                skip_nanoplot = true
                skip_multiqc = true
                
                // Minimal resources
                max_cpus = 1
                max_memory = '2.GB'
                max_time = '5.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(file("${outputDir}/pipeline_info/software_versions.yml")).match("software_versions")
            
            if (workflow.success) {
                // Basic output validation
                assert path("$outputDir").exists()
            }
        }
    }

    test("Should handle minimal statistics generation") {

        when {
            params {
                input = "$projectDir/assets/test_data/test_samplesheet_absolute.csv"
                outdir = "$outputDir"
                
                // Minimal configuration
                enable_realtime_stats = false
                skip_fastp = true
                skip_nanoplot = true
                skip_multiqc = true
                
                // Quick execution
                max_cpus = 1
                max_memory = '1.GB'
                max_time = '2.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(file("${outputDir}/pipeline_info/software_versions.yml")).match("software_versions")
            
            // Should complete within time limit
            // REMOVED: workflow.duration property not available in nf-test
            // assert workflow.duration.toMillis() < 180000 // Less than 3 minutes
        }
    }
}