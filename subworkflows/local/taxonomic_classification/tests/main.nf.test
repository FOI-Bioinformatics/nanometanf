nextflow_workflow {

    name "Test TAXONOMIC_CLASSIFICATION"
    script "../main.nf"
    workflow "TAXONOMIC_CLASSIFICATION"

    test("Should perform basic Kraken2 taxonomic classification") {

        when {
            workflow {
                """
                input[0] = [
                    [id: 'classification_test', single_end: true],
                    file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                ]
                input[1] = file('$projectDir/tests/fixtures/kraken2_db')
                """
            }

            params {
                classifier = 'kraken2'
                taxpasta_format = 'tsv'
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '2.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out.versions).match()
            assert workflow.out.classified_reads
            assert workflow.out.report
            assert workflow.out.versions

            // Verify Kraken2 processing
            def reports = workflow.out.report.toList()
            assert reports.size() >= 1

            // Verify classified reads output
            def classified_reads = workflow.out.classified_reads.toList()
            assert classified_reads.size() >= 1
        }
    }

    test("Should handle multiple classification formats") {

        when {
            workflow {
                """
                input[0] = [
                    [id: 'format_test', single_end: true],
                    file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                ]
                input[1] = file('$projectDir/tests/fixtures/kraken2_db')
                """
            }

            params {
                classifier = 'kraken2'
                taxpasta_format = 'biom'
                save_output_fastqs = true
                save_reads_assignment = true
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '2.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out.versions).match()
            assert workflow.out.classified_reads
            assert workflow.out.unclassified_reads
            assert workflow.out.report
            assert workflow.out.reads_assignment

            // Verify multiple output types
            def classified_reads = workflow.out.classified_reads.toList()
            assert classified_reads.size() >= 1

            def unclassified_reads = workflow.out.unclassified_reads.toList()
            assert unclassified_reads.size() >= 1

            def assignments = workflow.out.reads_assignment.toList()
            assert assignments.size() >= 1
        }
    }

    test("Should process multiple samples in batch") {

        when {
            workflow {
                """
                input[0] = [
                    [
                        [id: 'batch_sample1', single_end: true],
                        file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                    ],
                    [
                        [id: 'batch_sample2', single_end: true],
                        file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                    ],
                    [
                        [id: 'batch_sample3', single_end: true],
                        file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                    ]
                ]
                input[1] = file('$projectDir/tests/fixtures/kraken2_db')
                """
            }

            params {
                classifier = 'kraken2'
                taxpasta_format = 'tsv'
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '3.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out.versions).match()
            assert workflow.out.classified_reads
            assert workflow.out.report

            // Verify batch processing
            def reports = workflow.out.report.toList()
            assert reports.size() >= 3

            def classified_reads = workflow.out.classified_reads.toList()
            assert classified_reads.size() >= 3
        }
    }

    test("Should handle classification confidence thresholds") {

        when {
            workflow {
                """
                input[0] = [
                    [id: 'confidence_test', single_end: true],
                    file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                ]
                input[1] = file('$projectDir/tests/fixtures/kraken2_db')
                """
            }

            params {
                classifier = 'kraken2'
                taxpasta_format = 'tsv'
                kraken2_confidence = 0.75
                kraken2_minimum_base_quality = 20
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '2.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out.versions).match()
            assert workflow.out.classified_reads
            assert workflow.out.report

            // Verify confidence-based processing
            def reports = workflow.out.report.toList()
            assert reports.size() >= 1
        }
    }

    test("Should standardize output with Taxpasta") {

        when {
            workflow {
                """
                input[0] = [
                    [id: 'taxpasta_test', single_end: true],
                    file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                ]
                input[1] = file('$projectDir/tests/fixtures/kraken2_db')
                """
            }

            params {
                classifier = 'kraken2'
                taxpasta_format = 'biom'
                enable_taxpasta_standardization = true
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '2.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out.versions).match()
            assert workflow.out.report
            assert workflow.out.standardized_report

            // Verify Taxpasta standardization
            if (workflow.out.standardized_report) {
                def standardized = workflow.out.standardized_report.toList()
                assert standardized.size() >= 1
            }
        }
    }

    test("Should handle empty input gracefully") {

        when {
            workflow {
                """
                input[0] = []
                input[1] = file('$projectDir/tests/fixtures/kraken2_db')
                """
            }

            params {
                classifier = 'kraken2'
                taxpasta_format = 'tsv'
                max_cpus = 1
                max_memory = '2.GB'
                max_time = '1.min'
            }
        }

        then {
            // Should handle empty input gracefully
            assert workflow.success
            assert snapshot(workflow.out.versions).match()

            if (workflow.success) {
                // Empty outputs expected
                if (workflow.out.classified_reads) {
                    def classified_reads = workflow.out.classified_reads.toList()
                    assert classified_reads.size() == 0
                }
            }
        }
    }

    test("Should support different Kraken2 database types") {

        when {
            workflow {
                """
                input[0] = [
                    [id: 'db_type_test', single_end: true],
                    file('$projectDir/tests/fixtures/fastq/test_sample.fastq.gz')
                ]
                input[1] = file('$projectDir/tests/fixtures/kraken2_db')
                """
            }

            params {
                classifier = 'kraken2'
                taxpasta_format = 'tsv'
                kraken2_use_names = true
                kraken2_report_zero_counts = true
                max_cpus = 2
                max_memory = '4.GB'
                max_time = '2.min'
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out.versions).match()
            assert workflow.out.classified_reads
            assert workflow.out.report

            // Verify database-specific processing
            def reports = workflow.out.report.toList()
            assert reports.size() >= 1
        }
    }
}